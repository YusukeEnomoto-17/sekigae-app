<!-- templates/step3_public_conditions.html -->
{% extends "layout.html" %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white p-8 rounded-xl shadow-md">
    <h2 class="text-2xl font-bold text-center mb-6">ğŸ“¢ åº§å¸­ã®å¸Œæœ›</h2>
    
    {% if error %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">ã‚¨ãƒ©ãƒ¼:</strong>
            <span class="block sm:inline">{{ error }}</span>
        </div>
    {% endif %}

    <form method="post" id="conditions-form">
        <!-- å…¬é–‹æ¡ä»¶ -->
        <div class="mb-8 p-6 border border-gray-200 rounded-lg">
             <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- æœ€å‰åˆ—å¸Œæœ› -->
                <div>
                    <h4 class="font-semibold text-lg mb-2">ğŸ‘“ æœ€å‰åˆ—ãŒè‰¯ã„ç”Ÿå¾’</h4>
                    <div class="w-full h-40 border rounded-md p-2 overflow-y-auto bg-white">
                        {% for s in students %}<label class="flex items-center p-1 hover:bg-gray-100 rounded"><input type="checkbox" name="public_front_row_list" value="{{ s.id }}" {% if s.id in constraints.get('public_front', []) %}checked{% endif %} class="mr-2 h-4 w-4">{{ s.name }}</label>{% endfor %}
                    </div>
                </div>
                <!-- æœ€å¾Œåˆ—å¸Œæœ› -->
                <div>
                    <h4 class="font-semibold text-lg mb-2">ğŸ¦’ æœ€å¾Œåˆ—ãŒè‰¯ã„ç”Ÿå¾’</h4>
                    <div class="w-full h-40 border rounded-md p-2 overflow-y-auto bg-white">
                        {% for s in students %}<label class="flex items-center p-1 hover:bg-gray-100 rounded"><input type="checkbox" name="public_back_row_list" value="{{ s.id }}" {% if s.id in constraints.get('public_back', []) %}checked{% endif %} class="mr-2 h-4 w-4">{{ s.name }}</label>{% endfor %}
                    </div>
                </div>
                <!-- å¸­ã‹ã‚‰é™¤å¤– -->
                <div>
                    <h4 class="font-semibold text-lg mb-2">âœˆï¸ å¸­æ›¿ãˆã‹ã‚‰é™¤ãç”Ÿå¾’</h4>
                    <p class="text-sm text-gray-600 mb-1">ç•™å­¦ä¸­ãªã©ã€ä»Šå›å¸­ãŒä¸è¦ãªç”Ÿå¾’ã€‚</p>
                    <div class="w-full h-40 border rounded-md p-2 overflow-y-auto bg-white">
                        {% for s in students %}<label class="flex items-center p-1 hover:bg-gray-100 rounded"><input type="checkbox" name="exclude_list" value="{{ s.id }}" {% if s.id in constraints.get('exclude', []) %}checked{% endif %} class="mr-2 h-4 w-4">{{ s.name }}</label>{% endfor %}
                    </div>
                </div>
             </div>
        </div>
        
        <!-- åº§å¸­å›ºå®š -->
        <div class="p-6 border border-gray-200 rounded-lg">
            <h3 class="text-xl font-bold text-gray-700 mb-4">ğŸ“Œ åº§å¸­ã‚’å›ºå®šã™ã‚‹ç”Ÿå¾’</h3>
            <p class="text-sm text-gray-600 mb-3">ç‰¹åˆ¥ãªäº‹æƒ…ã§åº§å¸­ã‚’å›ºå®šã—ãŸã„ç”Ÿå¾’ã‚’é¸æŠã—ã€åº§å¸­ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>
            <div class="flex gap-4">
                <select id="fixed-student-select" class="border rounded-md p-2">
                    <option value="">ç”Ÿå¾’ã‚’é¸æŠ...</option>
                    {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                </select>
                <select id="fixed-seat-select" class="border rounded-md p-2">
                    <option value="">åº§å¸­ã‚’é¸æŠ...</option>
                    {% for seat in active_seats %}
                    <option value="[{{seat[0]}},{{seat[1]}}]">(ã‚¿ãƒ†{{seat[0]+1}}, ãƒ¨ã‚³{{seat[1]+1}})</option>
                    {% endfor %}
                </select>
                <button type="button" id="add-fixed-seat" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">è¿½åŠ </button>
            </div>
            <ul id="fixed-seat-list" class="mt-4 list-disc list-inside"></ul>
        </div>

        <input type="hidden" name="fixed_seat_list" id="fixed-seat-list-data">

        <div class="flex flex-wrap justify-between items-center mt-8 gap-4">
            <a href="{{ url_for('step2_secret_conditions') }}" class="text-gray-600 hover:text-gray-800">&larr; æˆ»ã‚‹</a>
            <div class="flex flex-wrap gap-4">
                <button type="submit" formaction="{{ url_for('ordered_arrangement') }}" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-md hover:bg-gray-700 transition-colors duration-300 text-lg">
                    å·¦å‰ã‹ã‚‰å‡ºå¸­ç•ªå·é †
                </button>
                <button type="submit" formaction="{{ url_for('step3_public_conditions') }}" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition-colors duration-300 text-lg">
                    ãƒ©ãƒ³ãƒ€ãƒ å¸­æ›¿ãˆã‚’å®Ÿè¡Œ &rarr;
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fixedSeatList = document.getElementById('fixed-seat-list');
    document.getElementById('add-fixed-seat').addEventListener('click', () => {
        const studentSelect = document.getElementById('fixed-student-select');
        const seatSelect = document.getElementById('fixed-seat-select');
        const studentId = studentSelect.value;
        const studentName = studentSelect.options[studentSelect.selectedIndex].text;
        const seatPos = seatSelect.value;
        const seatText = seatSelect.options[seatSelect.selectedIndex].text;
        if (!studentId || !seatPos) { alert('ç”Ÿå¾’ã¨åº§å¸­ã®ä¸¡æ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
        const li = document.createElement('li');
        li.textContent = `${studentName} â†’ ${seatText}`;
        li.dataset.fixed = JSON.stringify({ student_id: parseInt(studentId), pos: JSON.parse(seatPos) });
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'âœ–';
        removeBtn.className = 'ml-2 text-red-500';
        removeBtn.onclick = () => li.remove();
        li.appendChild(removeBtn);
        fixedSeatList.appendChild(li);
        studentSelect.value = '';
        seatSelect.value = '';
    });
    
    const form = document.getElementById('conditions-form');
    form.addEventListener('submit', (e) => {
        document.getElementById('fixed-seat-list-data').value = JSON.stringify(Array.from(document.querySelectorAll('#fixed-seat-list li')).map(li => JSON.parse(li.dataset.fixed)));
    });
});
</script>
{% endblock %}
