<!-- templates/step4_roulette.html -->
{% extends "layout.html" %}
{% block content %}
<div class="max-w-7xl mx-auto text-center">
    <div id="roulette-area" class="relative w-full bg-gray-100 p-4 rounded-lg shadow-inner min-h-[60vh] flex items-center justify-center">
        <!-- 初期メッセージ -->
        <div id="initial-message" class="text-center">
            <h2 class="text-3xl font-bold text-gray-700 mb-4">準備完了</h2>
            <p class="text-gray-600 mb-8">下のボタンを押して、席替えを開始します。</p>
            <button id="start-roulette" class="bg-blue-600 text-white font-bold py-4 px-8 rounded-md hover:bg-blue-700 transition-colors duration-300 text-xl shadow-lg">
                席替えスタート！
            </button>
        </div>
        
        <!-- ルーレット表示エリア -->
        <div id="roulette-display" class="hidden">
             <div id="seat-map-container" class="grid gap-2" style="display: none;">
                <!-- JavaScriptで座席が生成される -->
            </div>
            <p id="ai-message" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-gray-500 text-sm hidden"></p>
        </div>
        
        <!-- 結果表示エリア -->
        <div id="result-area" class="hidden text-center">
            <h2 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600 mb-6 animate-pulse">新しい座席が決定しました！</h2>
            <div id="final-seat-map-container" class="grid gap-2 max-w-5xl mx-auto mb-8">
                <!-- JavaScriptで最終的な座席が生成される -->
            </div>
            <div class="flex flex-wrap justify-center items-center gap-4">
                <a href="{{ url_for('print_view') }}" target="_blank" class="bg-green-600 text-white font-bold py-3 px-6 rounded-md hover:bg-green-700 transition-colors duration-300">
                    印刷用ページを開く
                </a>
                 <button id="verify-button" class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-md hover:bg-yellow-600 transition-colors duration-300">
                    ？
                </button>
                <a href="{{ url_for('step3_public_conditions') }}" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-md hover:bg-gray-600 transition-colors duration-300">
                    個別設定に戻る
                </a>
                <a href="{{ url_for('index') }}" class="text-gray-600 hover:text-gray-800">最初から設定</a>
            </div>
        </div>
    </div>
</div>

<!-- 条件確認モーダル -->
<div id="verification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl h-[90vh] flex flex-col p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold">条件達成状況の確認</h3>
            <button id="close-modal" class="text-2xl font-bold">&times;</button>
        </div>
        <div class="flex-grow grid md:grid-cols-3 gap-6 overflow-hidden">
            <!-- 座席表エリア -->
            <div class="md:col-span-2 overflow-auto pr-4">
                <div id="verification-seat-map" class="grid gap-2">
                    <!-- Verification seat map here -->
                </div>
            </div>
            <!-- 凡例＆条件リストエリア -->
            <div class="overflow-auto pl-4 border-l">
                 <!-- 凡例 -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold mb-3 text-lg">凡例</h4>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-100 border border-green-400 mr-2"></span>条件を全て満たしています</li>
                        <li class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-100 border border-red-400 mr-2"></span>条件違反があります</li>
                        <li class="flex items-center"><span class="text-red-500">💔</span>：「離す」指定の生徒</li>
                        <li class="flex items-center"><span class="text-pink-500">💖</span>：「くっつける」指定の生徒</li>
                    </ul>
                </div>
                <!-- 設定した条件リスト -->
                 <div id="constraints-list-container" class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold mb-3 text-lg">設定した条件リスト</h4>
                    <div id="constraints-list" class="text-sm space-y-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('start-roulette');
    const rouletteDisplay = document.getElementById('roulette-display');
    const seatMapContainer = document.getElementById('seat-map-container');
    const initialMessage = document.getElementById('initial-message');
    const resultArea = document.getElementById('result-area');
    const finalSeatMapContainer = document.getElementById('final-seat-map-container');
    const aiMessage = document.getElementById('ai-message');
    const verifyButton = document.getElementById('verify-button');

    let solutions = [];
    let randoms = [];
    let allArrangements = [];
    let rouletteInterval;
    let finalArrangement;
    
    function createSeatElement(student) {
        const seatDiv = document.createElement('div');
        seatDiv.className = 'p-2 rounded-md aspect-video flex items-center justify-center text-center';
        if (student) {
            seatDiv.className += ' bg-blue-200 border border-blue-400';
            seatDiv.innerHTML = `<span class="font-semibold text-sm">${student.name}</span>`;
        } else {
            seatDiv.className += ' bg-gray-200';
        }
        return seatDiv;
    }

    function renderSeatMap(container, arrangement, verificationData = {}) {
        container.innerHTML = '';
        const maxRow = Math.max(...arrangement.map(s => s.pos[0]));
        const maxCol = Math.max(...arrangement.map(s => s.pos[1]));
        container.style.gridTemplateColumns = `repeat(${maxCol + 1}, 1fr)`;

        const arrangementMap = new Map(arrangement.map(s => [s.pos.join(','), s.student]));

        const blackboard = document.createElement('div');
        blackboard.textContent = '教卓';
        blackboard.className = 'col-span-full bg-gray-800 text-white text-center py-2 rounded-md font-bold mb-2';
        container.appendChild(blackboard);

        for (let r = 0; r <= maxRow; r++) {
            for (let c = 0; c <= maxCol; c++) {
                const student = arrangementMap.get(`${r},${c}`);
                if (student !== undefined) {
                    const seatDiv = createSeatElement(student);
                    if (student && verificationData[student.id]) {
                         const v = verificationData[student.id];
                         seatDiv.className = seatDiv.className.replace(/bg-\w+-\d+/g, v.status === 'ok' ? 'bg-green-100' : 'bg-red-100');
                         seatDiv.className = seatDiv.className.replace(/border-\w+-\d+/g, v.status === 'ok' ? 'border-green-400' : 'border-red-400');
                         
                         let detailsHTML = '';
                         if(v.tags.includes('apart')) detailsHTML += '<span class="text-red-500 text-xs">💔</span>';
                         if(v.tags.includes('together')) detailsHTML += '<span class="text-pink-500 text-xs">💖</span>';
                         
                         if(v.messages.length > 0) {
                            detailsHTML += `<div class="text-xs mt-1">${v.messages.join('<br>')}</div>`;
                         }
                         seatDiv.innerHTML = `<span class="font-semibold text-sm">${student.name}</span>${detailsHTML}`;
                    }
                    container.appendChild(seatDiv);
                } else {
                     container.appendChild(document.createElement('div'));
                }
            }
        }
    }

    startBtn.addEventListener('click', async () => {
        initialMessage.classList.add('hidden');
        rouletteDisplay.classList.remove('hidden');
        seatMapContainer.style.display = 'grid';
        aiMessage.textContent = 'AIが最適解を計算中です…';
        aiMessage.classList.remove('hidden');

        try {
            const response = await fetch('{{ url_for("api_generate_arrangements") }}');
            if (!response.ok) {
                 const errorData = await response.json();
                 alert('エラー: ' + (errorData.error || '席替え案の生成に失敗しました。'));
                 location.reload();
                 return;
            }
            const data = await response.json();
            solutions = data.solutions;
            randoms = data.randoms;

            if (solutions.length === 0) {
                 alert('エラー: 条件を満たす席替え案が見つかりませんでした。条件設定に戻ります。');
                 window.location.href = "{{ url_for('step3_public_conditions') }}";
                 return;
            }

            allArrangements = [...randoms, ...solutions];
            finalArrangement = solutions[Math.floor(Math.random() * solutions.length)];

            let count = 0;
            rouletteInterval = setInterval(() => {
                renderSeatMap(seatMapContainer, allArrangements[count % allArrangements.length]);
                count++;
            }, 100);

            setTimeout(() => {
                clearInterval(rouletteInterval);
                rouletteDisplay.classList.add('hidden');
                resultArea.classList.remove('hidden');
                renderSeatMap(finalSeatMapContainer, finalArrangement);
                
                fetch('{{ url_for("set_final_arrangement") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ arrangement: finalArrangement })
                });

            }, 5000);

        } catch (error) {
            console.error('Error fetching arrangements:', error);
            alert('サーバーとの通信に失敗しました。');
            location.reload();
        }
    });
    
    // Modal Logic
    const modal = document.getElementById('verification-modal');
    const closeModalBtn = document.getElementById('close-modal');

    verifyButton.addEventListener('click', async () => {
        try {
            const response = await fetch('{{ url_for("api_verify_arrangement") }}');
            if(!response.ok) {
                const errorData = await response.json();
                if(errorData.redirect) {
                    alert("セッションが切れました。最初のページに戻ります。");
                    window.location.href = errorData.redirect;
                } else {
                    alert('エラー: ' + (errorData.error || '確認データの取得に失敗しました。'));
                }
                return;
            }
            const data = await response.json();
            
            const verificationSeatMap = document.getElementById('verification-seat-map');
            renderSeatMap(verificationSeatMap, data.arrangement, data.verification);

            // Render constraints list
            const constraintsList = document.getElementById('constraints-list');
            const studentsMap = new Map(data.all_students.map(s => [s.id, s.name]));
            constraintsList.innerHTML = '';
            
            const createList = (title, items) => {
                if (items && items.length > 0) {
                    const div = document.createElement('div');
                    div.innerHTML = `<h5 class="font-semibold">${title}</h5>`;
                    const ul = document.createElement('ul');
                    ul.className = 'list-disc list-inside text-gray-700';
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        ul.appendChild(li);
                    });
                    div.appendChild(ul);
                    constraintsList.appendChild(div);
                }
            };
            
            createList('💔 離すペア:', data.constraints.apart?.map(p => `${studentsMap.get(p[0])} と ${studentsMap.get(p[1])}`));
            createList('💖 くっつけるペア:', data.constraints.together?.map(p => `${studentsMap.get(p[0])} と ${studentsMap.get(p[1])}`));
            createList('👓 最前列:', data.constraints.front?.map(id => studentsMap.get(id)));
            createList('🦒 最後列:', data.constraints.back?.map(id => studentsMap.get(id)));
            createList('📌 固定席:', data.constraints.fixed?.map(f => `${studentsMap.get(f.student_id)} → (タテ${f.pos[0]+1}, ヨコ${f.pos[1]+1})`));
            createList('✈️ 除外:', data.constraints.exclude?.map(id => studentsMap.get(id)));

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } catch(e) {
            console.error(e);
            alert("確認データの表示中にエラーが発生しました。");
        }
    });

    closeModalBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    });
});
</script>
{% endblock %}

