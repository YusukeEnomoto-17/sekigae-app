<!-- templates/step2_secret_conditions.html -->
{% extends "layout.html" %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white p-8 rounded-xl shadow-md">
    <h2 class="text-2xl font-bold text-center mb-6">ğŸ¤« è©³ç´°è¨­å®š (å…ˆç”Ÿç”¨)</h2>

    <form method="post" id="secret-conditions-form">
        <div class="grid md:grid-cols-2 gap-8">
            <!-- é›¢ã™ãƒšã‚¢ -->
            <div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">ğŸ’” é›¢ã—ãŸã„ãƒšã‚¢</h3>
                <p class="text-sm text-gray-600 mb-3">éš£æ¥ã•ã›ãŸããªã„ç”Ÿå¾’ã‚’2äººé¸ã‚“ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="flex gap-2 mb-3">
                    <select id="apart-select1" class="w-1/2 border rounded-md p-2">
                        <option value="">ç”Ÿå¾’1...</option>
                        {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                    </select>
                    <select id="apart-select2" class="w-1/2 border rounded-md p-2">
                        <option value="">ç”Ÿå¾’2...</option>
                        {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                    </select>
                    <button type="button" id="add-apart" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">è¿½åŠ </button>
                </div>
                <ul id="apart-list" class="h-40 border rounded-md p-2 overflow-y-auto bg-gray-50"></ul>
            </div>

            <!-- ãã£ã¤ã‘ã‚‹ãƒšã‚¢ -->
            <div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">ğŸ’– ãã£ã¤ã‘ãŸã„ãƒšã‚¢</h3>
                <p class="text-sm text-gray-600 mb-3">éš£æ¥ã•ã›ãŸã„ç”Ÿå¾’ã‚’2äººé¸ã‚“ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="flex gap-2 mb-3">
                    <select id="together-select1" class="w-1/2 border rounded-md p-2">
                        <option value="">ç”Ÿå¾’1...</option>
                        {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                    </select>
                    <select id="together-select2" class="w-1/2 border rounded-md p-2">
                        <option value="">ç”Ÿå¾’2...</option>
                        {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                    </select>
                    <button type="button" id="add-together" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">è¿½åŠ </button>
                </div>
                <ul id="together-list" class="h-40 border rounded-md p-2 overflow-y-auto bg-gray-50"></ul>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mt-8">
             <!-- æœ€å‰åˆ—å¸Œæœ› -->
             <div>
                <h4 class="font-semibold text-lg mb-2">ğŸ‘“ æœ€å‰åˆ—ãŒè‰¯ã„ç”Ÿå¾’</h4>
                <div class="w-full h-40 border rounded-md p-2 overflow-y-auto bg-white">
                    {% for s in students %}<label class="flex items-center p-1 hover:bg-gray-100 rounded"><input type="checkbox" name="secret_front_row_list" value="{{ s.id }}" {% if s.id in constraints.get('secret_front', []) %}checked{% endif %} class="mr-2 h-4 w-4">{{ s.name }}</label>{% endfor %}
                </div>
            </div>
            <!-- æœ€å¾Œåˆ—å¸Œæœ› -->
            <div>
                <h4 class="font-semibold text-lg mb-2">ğŸ¦’ æœ€å¾Œåˆ—ãŒè‰¯ã„ç”Ÿå¾’</h4>
                <div class="w-full h-40 border rounded-md p-2 overflow-y-auto bg-white">
                    {% for s in students %}<label class="flex items-center p-1 hover:bg-gray-100 rounded"><input type="checkbox" name="secret_back_row_list" value="{{ s.id }}" {% if s.id in constraints.get('secret_back', []) %}checked{% endif %} class="mr-2 h-4 w-4">{{ s.name }}</label>{% endfor %}
                </div>
            </div>
        </div>


        <input type="hidden" name="apart_list" id="apart-list-data">
        <input type="hidden" name="together_list" id="together-list-data">

        <div class="flex justify-between items-center mt-8">
            <a href="{{ url_for('step1_layout') }}" class="text-gray-600 hover:text-gray-800">&larr; æˆ»ã‚‹</a>
            <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition-colors duration-300 text-lg">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€ &rarr;</button>
        </div>
    </form>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const students = JSON.parse('{{ students | tojson | safe }}');
    const studentMap = new Map(students.map(s => [s.id, s.name]));

    function setupPairLogic(type) {
        const addBtn = document.getElementById(`add-${type}`);
        const select1 = document.getElementById(`${type}-select1`);
        const select2 = document.getElementById(`${type}-select2`);
        const list = document.getElementById(`${type}-list`);

        addBtn.addEventListener('click', () => {
            const id1 = parseInt(select1.value);
            const id2 = parseInt(select2.value);
            if (!id1 || !id2) { alert('ç”Ÿå¾’ã‚’2äººé¸ã‚“ã§ãã ã•ã„ã€‚'); return; }
            if (id1 === id2) { alert('åŒã˜ç”Ÿå¾’ã¯é¸ã¹ã¾ã›ã‚“ã€‚'); return; }
            const name1 = studentMap.get(id1);
            const name2 = studentMap.get(id2);
            
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-1';
            li.textContent = `${name1} ã¨ ${name2}`;
            li.dataset.pair = JSON.stringify([id1, id2].sort());

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = 'âœ–';
            removeBtn.className = 'ml-2 text-red-500';
            removeBtn.onclick = () => li.remove();
            
            li.appendChild(removeBtn);
            list.appendChild(li);
            select1.value = '';
            select2.value = '';
        });
    }

    setupPairLogic('apart');
    setupPairLogic('together');

    const form = document.getElementById('secret-conditions-form');
    form.addEventListener('submit', (e) => {
        document.getElementById('apart-list-data').value = JSON.stringify(Array.from(document.querySelectorAll('#apart-list li')).map(li => JSON.parse(li.dataset.pair)));
        document.getElementById('together-list-data').value = JSON.stringify(Array.from(document.querySelectorAll('#together-list li')).map(li => JSON.parse(li.dataset.pair)));
    });

    // --- ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ ---
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã•ã‚ŒãŸãƒšã‚¢æƒ…å ±ã‚’å¾©å…ƒã™ã‚‹
    const constraints = JSON.parse('{{ constraints | tojson | safe }}');

    function restorePairList(type, pairs) {
        if (!pairs) return;
        const list = document.getElementById(`${type}-list`);
        pairs.forEach(pair => {
            const id1 = pair[0];
            const id2 = pair[1];
            const name1 = studentMap.get(id1);
            const name2 = studentMap.get(id2);
            if(name1 && name2) {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-1';
                li.textContent = `${name1} ã¨ ${name2}`;
                li.dataset.pair = JSON.stringify(pair);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'âœ–';
                removeBtn.className = 'ml-2 text-red-500';
                removeBtn.onclick = () => li.remove();
                
                li.appendChild(removeBtn);
                list.appendChild(li);
            }
        });
    }

    restorePairList('apart', constraints.apart);
    restorePairList('together', constraints.together);
    // --- ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ ---
});
</script>
{% endblock %}

