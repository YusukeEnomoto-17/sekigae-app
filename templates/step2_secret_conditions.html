<!-- templates/step2_secret_conditions.html -->
{% extends "layout.html" %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white p-8 rounded-xl shadow-md">
    <h2 class="text-2xl font-bold text-center mb-6">🤫 詳細設定 (先生用)</h2>

    <form method="post" id="secret-conditions-form">
        <div class="grid md:grid-cols-2 gap-8">
            <!-- 離すペア -->
            <div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">💔 離したいペア</h3>
                <p class="text-sm text-gray-600 mb-3">隣接させたくない生徒を2人選んで追加してください。</p>
                <div class="flex gap-2 mb-3">
                    <select id="apart-select1" class="w-1/2 border rounded-md p-2">
                        <option value="">生徒1...</option>
                        {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                    </select>
                    <select id="apart-select2" class="w-1/2 border rounded-md p-2">
                        <option value="">生徒2...</option>
                        {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                    </select>
                    <button type="button" id="add-apart" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">追加</button>
                </div>
                <ul id="apart-list" class="h-40 border rounded-md p-2 overflow-y-auto bg-gray-50"></ul>
            </div>

            <!-- くっつけるペア -->
            <div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">💖 くっつけたいペア</h3>
                <p class="text-sm text-gray-600 mb-3">隣接させたい生徒を2人選んで追加してください。</p>
                <div class="flex gap-2 mb-3">
                    <select id="together-select1" class="w-1/2 border rounded-md p-2">
                        <option value="">生徒1...</option>
                        {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                    </select>
                    <select id="together-select2" class="w-1/2 border rounded-md p-2">
                        <option value="">生徒2...</option>
                        {% for s in students %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                    </select>
                    <button type="button" id="add-together" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">追加</button>
                </div>
                <ul id="together-list" class="h-40 border rounded-md p-2 overflow-y-auto bg-gray-50"></ul>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mt-8">
             <!-- 最前列希望 -->
             <div>
                <h4 class="font-semibold text-lg mb-2">👓 最前列が良い生徒</h4>
                <div class="w-full h-40 border rounded-md p-2 overflow-y-auto bg-white">
                    {% for s in students %}<label class="flex items-center p-1 hover:bg-gray-100 rounded"><input type="checkbox" name="secret_front_row_list" value="{{ s.id }}" {% if s.id in constraints.get('secret_front', []) %}checked{% endif %} class="mr-2 h-4 w-4">{{ s.name }}</label>{% endfor %}
                </div>
            </div>
            <!-- 最後列希望 -->
            <div>
                <h4 class="font-semibold text-lg mb-2">🦒 最後列が良い生徒</h4>
                <div class="w-full h-40 border rounded-md p-2 overflow-y-auto bg-white">
                    {% for s in students %}<label class="flex items-center p-1 hover:bg-gray-100 rounded"><input type="checkbox" name="secret_back_row_list" value="{{ s.id }}" {% if s.id in constraints.get('secret_back', []) %}checked{% endif %} class="mr-2 h-4 w-4">{{ s.name }}</label>{% endfor %}
                </div>
            </div>
        </div>


        <input type="hidden" name="apart_list" id="apart-list-data">
        <input type="hidden" name="together_list" id="together-list-data">

        <div class="flex justify-between items-center mt-8">
            <a href="{{ url_for('step1_layout') }}" class="text-gray-600 hover:text-gray-800">&larr; 戻る</a>
            <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition-colors duration-300 text-lg">次のステップへ進む &rarr;</button>
        </div>
    </form>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const students = JSON.parse('{{ students | tojson | safe }}');
    const studentMap = new Map(students.map(s => [s.id, s.name]));

    function setupPairLogic(type) {
        const addBtn = document.getElementById(`add-${type}`);
        const select1 = document.getElementById(`${type}-select1`);
        const select2 = document.getElementById(`${type}-select2`);
        const list = document.getElementById(`${type}-list`);

        addBtn.addEventListener('click', () => {
            const id1 = parseInt(select1.value);
            const id2 = parseInt(select2.value);
            if (!id1 || !id2) { alert('生徒を2人選んでください。'); return; }
            if (id1 === id2) { alert('同じ生徒は選べません。'); return; }
            const name1 = studentMap.get(id1);
            const name2 = studentMap.get(id2);
            
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-1';
            li.textContent = `${name1} と ${name2}`;
            li.dataset.pair = JSON.stringify([id1, id2].sort());

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '✖';
            removeBtn.className = 'ml-2 text-red-500';
            removeBtn.onclick = () => li.remove();
            
            li.appendChild(removeBtn);
            list.appendChild(li);
            select1.value = '';
            select2.value = '';
        });
    }

    setupPairLogic('apart');
    setupPairLogic('together');

    const form = document.getElementById('secret-conditions-form');
    form.addEventListener('submit', (e) => {
        document.getElementById('apart-list-data').value = JSON.stringify(Array.from(document.querySelectorAll('#apart-list li')).map(li => JSON.parse(li.dataset.pair)));
        document.getElementById('together-list-data').value = JSON.stringify(Array.from(document.querySelectorAll('#together-list li')).map(li => JSON.parse(li.dataset.pair)));
    });

    // --- ここからが修正箇所 ---
    // ページ読み込み時に、セッションに保存されたペア情報を復元する
    const constraints = JSON.parse('{{ constraints | tojson | safe }}');

    function restorePairList(type, pairs) {
        if (!pairs) return;
        const list = document.getElementById(`${type}-list`);
        pairs.forEach(pair => {
            const id1 = pair[0];
            const id2 = pair[1];
            const name1 = studentMap.get(id1);
            const name2 = studentMap.get(id2);
            if(name1 && name2) {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-1';
                li.textContent = `${name1} と ${name2}`;
                li.dataset.pair = JSON.stringify(pair);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = '✖';
                removeBtn.className = 'ml-2 text-red-500';
                removeBtn.onclick = () => li.remove();
                
                li.appendChild(removeBtn);
                list.appendChild(li);
            }
        });
    }

    restorePairList('apart', constraints.apart);
    restorePairList('together', constraints.together);
    // --- 修正箇所ここまで ---
});
</script>
{% endblock %}

